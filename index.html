<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النوتة المصرية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
        }
        .ltr {  
            direction: ltr;
            unicode-bidi: bidi-override;
        }
        .group-page {
            display: none;
        }
        .group-page.active {
            display: block;
        }
        /* إضافة القاعدة التالية لتغيير لون خلفية Textbox الأول فقط إلى اللون الأخضر بأسلوب حديث */
        .group-page .group-title {
            background-color: #d4edda; /* لون خلفية أخضر فاتح */
            border: 1px solid #c3e6cb; /* حدود خضراء */
            border-radius: 0.375rem; /* زوايا مستديرة */
            padding: 0.5rem; /* حشوة داخلية */
            transition: background-color 0.3s ease, border-color 0.3s ease; /* تأثير انتقال */
        }
        .group-page .group-title:focus {
            background-color: #c3e6cb; /* لون خلفية أخضر أغمق عند التركيز */
            border-color: #a5d6a7; /* حدود خضراء أغمق عند التركيز */
        }
        .section-divider {
            border-top: 2px solid red; /* خط فاصل أحمر */
            margin-top: 1rem; /* مسافة من الأعلى */
            margin-bottom: 1rem; /* مسافة من الأسفل */
        }
        .popup {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .popup button {
            margin: 2px;
            padding: 2px 5px;
            border: none;
            cursor: pointer;
        }
        .color-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <center><h3 class="text-3xl font-bold mb-6 text-gray-800">النوتة المصرية : صنعت بواسطة محمد جمعة</h3></center>
        
        <!-- إضافة التنقل بين المجموعات -->
        <div id="groupNavigation" class="mb-6 flex flex-wrap gap-2">
            <!-- سيتم إضافة أزرار التنقل هنا ديناميكيًا -->
        </div>
        
        <!-- إضافة مربع البحث -->
        <div class="mb-6">
            <input type="text" id="searchBox" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none" placeholder="ابحث في المجموعات والأقسام والخطوات..." oninput="performSearch()">
        </div>
        
        <div id="groups">
            <!-- سيتم إضافة المجموعات هنا ديناميكيًا -->
        </div>

        <div class="flex flex-wrap gap-4 mt-8">
            <button onclick="addGroup()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 ease-in-out">إضافة مجموعة جديدة</button>
            <button onclick="deleteCurrentGroup()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out">حذف المجموعة الحالية</button>
        </div>
        <div class="flex flex-wrap gap-4 mt-4">
            <button onclick="loadFromXMLFile()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-300 ease-in-out">تحميل من ملف XML</button>
            <button onclick="saveToXMLFile()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300 ease-in-out">استخراج إلى ملف XML</button>
        </div>

        <div class="mt-8">
            <div class="flex flex-col gap-4">
                <input type="text" id="gistId" class="border border-gray-300 rounded-lg px-2 py-1" placeholder="معرف Gist">
                <input type="text" id="personalKey" class="border border-gray-300 rounded-lg px-2 py-1" placeholder="المفتاح الشخصي">
            </div>
            <div class="flex gap-4 mt-4">
                <button onclick="loadFromSpecificGist()" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-300 ease-in-out">تحميل من السيرفر</button>
                <button onclick="saveToSpecificGist()" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition duration-300 ease-in-out">حفظ الى السيرفر</button>
            </div>
        </div>

        <!-- Add this new div for displaying outputs -->
        <div id="outputArea" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
            <p id="outputMessage" class="text-gray-800"></p>
        </div>
    </div>

    <div id="stylePopup" class="popup" style="display: none;">
        <button onclick="applyStyle('bold')">B</button>
        <button class="color-btn" style="background-color: red;" onclick="applyStyle('color', 'red')"></button>
        <button class="color-btn" style="background-color: blue;" onclick="applyStyle('color', 'blue')"></button>
        <button class="color-btn" style="background-color: green;" onclick="applyStyle('color', 'green')"></button>
        <button class="color-btn" style="background-color: yellow;" onclick="applyStyle('color', 'yellow')"></button>
    </div>
    <script>
        let groupCount = 0;

        function addGroup(title = "") {
            groupCount++;
            const groupId = `group-${groupCount}`;
            const groupHtml = `
                <div id="${groupId}" class="group-page border-t border-gray-200 pt-6 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" class="group-title text-2xl font-semibold w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-right" placeholder="اسم المجموعة" value="${title}" onchange="updateGroupNavigation(this)">
                        <button onclick="removeGroup('${groupId}')" class="text-red-500 hover:text-red-700 ml-2">×</button>
                    </div>
                    <div class="sections space-y-6">
                        <!-- Sections will be dynamically added here -->
                    </div>
                    <button onclick="addSection('${groupId}')" class="mt-4 bg-gray-200 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-300 transition duration-300 ease-in-out">إضافة قسم</button>
                </div>
            `;
            document.getElementById('groups').insertAdjacentHTML('beforeend', groupHtml);
            updateGroupNavigation();
            showGroup(groupId);
        }

        function updateGroupNavigation() {
            const navigationHtml = Array.from(document.querySelectorAll('#groups > div')).map((group, index) => {
                const groupId = group.id;
                const groupTitle = group.querySelector('input').value || `مجموعة ${index + 1}`;
                return `<button onclick="showGroup('${groupId}')" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-300 ease-in-out">${groupTitle}</button>`;
            }).join('');
            document.getElementById('groupNavigation').innerHTML = navigationHtml;
        }

        function showGroup(groupId) {
            document.querySelectorAll('.group-page').forEach(group => {
                group.classList.remove('active');
            });
            document.getElementById(groupId).classList.add('active');
        }

        function removeGroup(groupId) {
            document.getElementById(groupId).remove();
            updateGroupNavigation();
            const firstGroup = document.querySelector('.group-page');
            if (firstGroup) {
                showGroup(firstGroup.id);
            }
        }

        function addSection(groupId, title = "") {
            const sectionHtml = `
                <section class="border-t border-gray-200 pt-4">
                    <div class="section-divider"></div>
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="toggleSection(this)" class="text-blue-500 hover:text-blue-700 ml-2">-</button>
                        <input type="text" class="text-xl font-semibold w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-right" placeholder="عنوان القسم" value="${title}" onchange="updateXML()">
                        <button onclick="removeSection(this)" class="text-red-500 hover:text-red-700 mr-2">×</button>
                    </div>
                    <div class="section-content hidden">
                        <ol class="list-decimal pr-6 space-y-4">
                            <!-- Steps will be dynamically added here -->
                        </ol>
                        <button onclick="addStep(this)" class="mt-4 bg-gray-200 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-300 transition duration-300 ease-in-out">إضافة خطوة</button>
                    </div>
                </section>
            `;
            document.querySelector(`#${groupId} .sections`).insertAdjacentHTML('beforeend', sectionHtml);
        }

        function addStep(button, description = "", command = "", link = "", codeBlock = "", imageUrl = "") {
            const stepHtml = `
                <li class="group relative">
                    <div class="flex items-center mb-2">
                        <button onclick="toggleStepButtons(this)" class="text-blue-500 hover:text-blue-700 ml-2">+</button>
                        <textarea class="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none text-right resize-none overflow-hidden" placeholder="وصف الخطوة" oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';" onchange="updateXML()">${description}</textarea>
                        <button onclick="removeStep(this)" class="text-red-500 hover:text-red-700 mr-2 opacity-0 group-hover:opacity-100 transition duration-300 ease-in-out">×</button>
                    </div>
                    <div class="step-buttons flex space-x-2 mb-2 hidden">
                        <button onclick="addLink(this)" class="bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition duration-300 ease-in-out">إضافة رابط</button>
                        <button onclick="addCodeBlock(this)" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600 transition duration-300 ease-in-out">إضافة كود</button>
                        <button onclick="addCommand(this)" class="bg-yellow-500 text-white text-xs px-2 py-1 rounded hover:bg-yellow-600 transition duration-300 ease-in-out">إضافة أمر</button>
                        <button onclick="addImage(this)" class="bg-pink-500 text-white text-xs px-2 py-1 rounded hover:bg-pink-600 transition duration-300 ease-in-out">إضافة صورة من على الانترنت</button>
                        <button onclick="browseFile(this)" class="bg-purple-500 text-white text-xs px-2 py-1 rounded hover:bg-purple-600 transition duration-300 ease-in-out">إضافة صورة من الجهاز</button>
                    </div>
                    ${link ? `<div class="link-box bg-blue-100 p-2 rounded-lg mb-2">
                        <a href="${link}" target="_blank" class="text-blue-600 hover:underline break-words">
                            <span class="inline-block max-w-full">${link}</span>
                        </a>
                        <button onclick="removeLink(this)" class="text-red-500 hover:text-red-700 ml-2">×</button>
                    </div>` : ''}
                    ${codeBlock ? `<div class="code-block bg-gray-100 p-2 rounded-lg mb-2">
                        <textarea dir="ltr" class="w-full h-32 p-2 bg-gray-800 text-white font-mono text-sm resize-y" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight + 5) + 'px';">${escapeXML(codeBlock)}</textarea>
                        <div class="mt-2 flex justify-between">
                            <button onclick="copyCodeToClipboard(this)" class="bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition duration-300 ease-in-out">نسخ الكود</button>
                            <button onclick="removeCodeBlock(this)" class="text-red-500 hover:text-red-700">إزالة الكود</button>
                        </div>
                    </div>` : ''}
                    ${command ? `<div class="bg-gray-800 text-white p-2 rounded-lg relative command-box">
                        <div class="flex items-center">
                            <button class="bg-red-500 text-xs px-2 py-1 rounded hover:bg-red-600 transition duration-300 ease-in-out ml-1" onclick="removeCommandBox(this)">×</button>
                            <button class="bg-gray-700 text-xs px-2 py-1 rounded hover:bg-gray-600 transition duration-300 ease-in-out ml-1" onclick="copyToClipboard(this)">نسخ</button>
                            <textarea class="flex-grow bg-transparent outline-none ltr text-left ml-2 resize-none overflow-hidden" placeholder="الأمر" oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';" onchange="updateXML()">${command}</textarea>
                        </div>
                    </div>` : ''}
                    ${imageUrl ? `<div class="image-box bg-gray-100 p-2 rounded-lg mb-2">
                        <img src="${imageUrl}" alt="صورة توضيحية" class="w-full h-auto cursor-pointer" onclick="showImagePopup('${imageUrl}')">
                        <button onclick="removeImage(this)" class="text-red-500 hover:text-red-700 mt-2">إزالة الصورة</button>
                    </div>` : ''}
                </li>
            `;
            button.closest('section').querySelector('ol').insertAdjacentHTML('beforeend', stepHtml);
        }

        function addLink(button) {
            const link = prompt("أدخل الرابط:");
            if (link) {
                const linkHtml = `
                    <div class="link-box bg-blue-100 p-2 rounded-lg mb-2">
                        <a href="${link}" target="_blank" class="text-blue-600 hover:underline break-words">
                            <span class="inline-block max-w-full">${link}</span>
                        </a>
                        <button onclick="removeLink(this)" class="text-red-500 hover:text-red-700 ml-2">×</button>
                    </div>
                `;
                button.closest('li').insertAdjacentHTML('beforeend', linkHtml);
                updateXML();
            }
        }

        function addCodeBlock(button) {
            const code = prompt("أدخل الكود:");
            if (code) {
                const codeHtml = `
                    <div class="code-block bg-gray-100 p-2 rounded-lg mb-2">
                        <textarea dir="ltr" class="w-full h-32 p-2 bg-gray-800 text-white font-mono text-sm resize-y" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight + 5) + 'px';">${escapeXML(code)}</textarea>
                        <div class="mt-2 flex justify-between">
                            <button onclick="copyCodeToClipboard(this)" class="bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition duration-300 ease-in-out">نسخ الكود</button>
                            <button onclick="removeCodeBlock(this)" class="text-red-500 hover:text-red-700">إزالة الكود</button>
                        </div>
                    </div>
                `;
                button.closest('li').insertAdjacentHTML('beforeend', codeHtml);
                updateXML();
            }
        }

        function copyCodeToClipboard(button) {
            const codeBlock = button.closest('.code-block');
            const codeText = codeBlock.querySelector('textarea').value;
            navigator.clipboard.writeText(codeText).then(() => {
                const originalText = button.textContent;
                button.textContent = 'تم النسخ!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        function removeLink(button) {
            button.closest('.link-box').remove();
            updateXML();
        }

        function removeCodeBlock(button) {
            button.closest('.code-block').remove();
            updateXML();
        }

        function removeSection(button) {
            button.closest('section').remove();
            updateXML();
        }

        function removeStep(button) {
            button.closest('li').remove();
            updateXML();
        }

        function copyToClipboard(button) {
            const commandBox = button.parentElement;
            const textToCopy = commandBox.querySelector('textarea').value;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = button.textContent;
                button.textContent = 'تم النسخ!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        function removeCommandBox(button) {
            button.closest('.command-box').remove();
            updateXML();
        }

        function updateXML() {
            // This function will be called whenever there's a change
            // We'll implement the full XML generation in saveToXML()
        }

        function saveToClipboard() {
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n<my_database>\n';
            
            document.querySelectorAll('#groups > div').forEach(group => {
                const groupTitle = group.querySelector('input').value;
                xmlContent += `  <group>\n    <title>${escapeXML(groupTitle)}</title>\n`;
                
                group.querySelectorAll('.sections > section').forEach(section => {
                    const sectionTitle = section.querySelector('input').value;
                    xmlContent += `    <section>\n      <title>${escapeXML(sectionTitle)}</title>\n`;
                    
                    section.querySelectorAll('ol > li').forEach(step => {
                        const stepDescription = step.querySelector('textarea').value;
                        const commandBox = step.querySelector('.command-box');
                        const linkBox = step.querySelector('.link-box');
                        const codeBlock = step.querySelector('.code-block');
                        const imageBox = step.querySelector('.image-box');
                        
                        xmlContent += `      <step>\n        <description>${escapeXML(stepDescription)}</description>\n`;
                        
                        if (linkBox) {
                            const link = linkBox.querySelector('a').href;
                            xmlContent += `        <link>${escapeXML(link)}</link>\n`;
                        }
                        
                        if (codeBlock) {
                            const code = codeBlock.querySelector('textarea').value;
                            xmlContent += `        <code_block>${escapeXML(code)}</code_block>\n`;
                        }
                        
                        if (commandBox) {
                            const command = commandBox.querySelector('textarea').value;
                            if (command) {
                                xmlContent += `        <command>${escapeXML(command)}</command>\n`;
                            }
                        }
                        
                        if (imageBox) {
                            const imageUrl = imageBox.querySelector('img').src;
                            xmlContent += `        <image>${escapeXML(imageUrl)}</image>\n`;
                        }
                        
                        xmlContent += `      </step>\n`;
                    });
                    
                    xmlContent += `    </section>\n`;
                });
                
                xmlContent += `  </group>\n`;
            });
            
            xmlContent += '</my_database>';
            
            navigator.clipboard.writeText(xmlContent).then(() => {
                alert("تم نسخ بيانات XML إلى الحافظة");
            }).catch(err => {
                console.error('فشل نسخ بيانات XML إلى الحافظة:', err);
                alert("فشل نسخ بيانات XML إلى الحافظة. انظر الكونسول للتفاصيل.");
            });
        }

        async function loadFromClipboard() {
            try {
                const clipboardText = await navigator.clipboard.readText();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(clipboardText, "text/xml");
                
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error("XML غير صالح في الحافظة");
                }
                
                // Clear existing groups
                document.getElementById('groups').innerHTML = '';
                groupCount = 0;

                // Parse and add groups, sections, and steps
                const groups = xmlDoc.getElementsByTagName('group');
                for (let group of groups) {
                    const groupTitle = group.getElementsByTagName('title')[0].textContent;
                    addGroup(groupTitle);
                    const sections = group.getElementsByTagName('section');
                    for (let section of sections) {
                        const sectionTitle = section.getElementsByTagName('title')[0].textContent;
                        addSection(`group-${groupCount}`, sectionTitle);
                        const steps = section.getElementsByTagName('step');
                        const sectionElement = document.querySelector(`#group-${groupCount} .sections section:last-child`);
                        for (let step of steps) {
                            const description = step.getElementsByTagName('description')[0].textContent;
                            const command = step.getElementsByTagName('command')[0]?.textContent || '';
                            const link = step.getElementsByTagName('link')[0]?.textContent || '';
                            const codeBlock = step.getElementsByTagName('code_block')[0]?.textContent || '';
                            const imageUrl = step.getElementsByTagName('image')[0]?.textContent || '';
                            addStep(sectionElement.querySelector('button'), description, command, link, codeBlock, imageUrl);
                        }
                    }
                }
                
                updateGroupNavigation();
                const firstGroup = document.querySelector('.group-page');
                if (firstGroup) {
                    showGroup(firstGroup.id);
                }
                
                alert("تم تحميل البيانات من الحافظة");
            } catch (err) {
                console.error('فشل تحميل XML من الحافظة:', err);
                alert("فشل تحميل XML من الحافظة. تأكد من وجود بيانات XML صالحة في الحافظة.");
            }
        }

        function escapeXML(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        // Initialize with one empty group
        addGroup();

        function performSearch() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const activeGroup = document.querySelector('.group-page.active');
            
            if (!activeGroup) return;

            const sections = activeGroup.querySelectorAll('.sections > section');
            sections.forEach(section => {
                const sectionTitle = section.querySelector('input').value.toLowerCase();
                const steps = section.querySelectorAll('ol > li');
                let sectionVisible = searchTerm === '' || sectionTitle.includes(searchTerm);

                steps.forEach(step => {
                    const stepDescription = step.querySelector('textarea').value.toLowerCase();
                    const command = step.querySelector('.command-box textarea')?.value.toLowerCase() || '';
                    const stepVisible = searchTerm === '' || 
                                        stepDescription.includes(searchTerm) || 
                                        command.includes(searchTerm);
                    
                    step.style.display = stepVisible ? '' : 'none';
                    if (stepVisible) {
                        sectionVisible = true;
                    }
                });

                section.style.display = sectionVisible ? '' : 'none';
            });
        }

        function deleteCurrentGroup() {
            const activeGroup = document.querySelector('.group-page.active');
            if (activeGroup) {
                removeGroup(activeGroup.id);
            }
        }

        function addCommand(button) {
            const command = prompt("أدخل الأمر:");
            if (command) {
                const commandHtml = `
                    <div class="bg-gray-800 text-white p-2 rounded-lg relative command-box">
                        <div class="flex items-center">
                            <button class="bg-red-500 text-xs px-2 py-1 rounded hover:bg-red-600 transition duration-300 ease-in-out ml-1" onclick="removeCommandBox(this)">×</button>
                            <button class="bg-gray-700 text-xs px-2 py-1 rounded hover:bg-gray-600 transition duration-300 ease-in-out ml-1" onclick="copyToClipboard(this)">نسخ</button>
                            <textarea class="flex-grow bg-transparent outline-none ltr text-left ml-2 resize-none overflow-hidden" placeholder="الأمر" oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';" onchange="updateXML()">${command}</textarea>
                        </div>
                    </div>
                `;
                button.closest('li').insertAdjacentHTML('beforeend', commandHtml);
            }
        }

        function toggleSection(button) {
            const sectionContent = button.closest('section').querySelector('.section-content');
            if (sectionContent.classList.contains('hidden')) {
                sectionContent.classList.remove('hidden');
                button.textContent = '-';
            } else {
                sectionContent.classList.add('hidden');
                button.textContent = '+';
            }
        }

        function toggleStepButtons(button) {
            const stepButtons = button.closest('li').querySelector('.step-buttons');
            if (stepButtons.classList.contains('hidden')) {
                stepButtons.classList.remove('hidden');
                button.textContent = '-';
            } else {
                stepButtons.classList.add('hidden');
                button.textContent = '+';
            }
        }

        function addImage(button) {
            const imageUrl = prompt("أدخل رابط الصورة:");
            if (imageUrl) {
                const imageHtml = `
                    <div class="image-box bg-gray-100 p-2 rounded-lg mb-2">
                        <img src="${imageUrl}" alt="صورة توضيحية" class="w-full h-auto cursor-pointer" onclick="showImagePopup('${imageUrl}')">
                        <button onclick="removeImage(this)" class="text-red-500 hover:text-red-700 mt-2">إزالة الصورة</button>
                    </div>
                `;
                button.closest('li').insertAdjacentHTML('beforeend', imageHtml);
                updateXML();
            }
        }

        function removeImage(button) {
            button.closest('.image-box').remove();
            updateXML();
        }

        function showImagePopup(imageUrl) {
            const popupHtml = `
                <div id="imagePopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-4 rounded-lg max-w-3xl max-h-[90vh] overflow-auto relative">
                        <button onclick="closeImagePopup()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-800">×</button>
                        <img src="${imageUrl}" alt="صورة مكبرة" class="max-w-full max-h-[80vh] object-contain">
                        <div class="mt-4 text-center">
                            <button onclick="zoomImage(1.1)" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">تكبير</button>
                            <button onclick="zoomImage(0.9)" class="bg-blue-500 text-white px-4 py-2 rounded">تصغير</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', popupHtml);
        }

        function closeImagePopup() {
            document.getElementById('imagePopup').remove();
        }

        function zoomImage(factor) {
            const img = document.querySelector('#imagePopup img');
            const currentWidth = img.width;
            img.style.width = `${currentWidth * factor}px`;
        }

        function saveCredentials() {
            const gistId = document.getElementById('gistId').value;
            const personalKey = document.getElementById('personalKey').value;

            if (!gistId || !personalKey) {
                alert('الرجاء إدخال جميع البيانات المطلوبة');
                return;
            }

            localStorage.setItem('gistId', gistId);
            localStorage.setItem('personalKey', personalKey);
            alert('تم حفظ البيانات بنجاح');
        }

        function getCredentials() {
            let gistId = localStorage.getItem('gistId');
            let personalKey = localStorage.getItem('personalKey');

            if (!gistId || !personalKey) {
                gistId = document.getElementById('gistId').value;
                personalKey = document.getElementById('personalKey').value;
            }

            if (!gistId || !personalKey) {
                alert('الرجاء إدخال معرف Gist والمفتاح الشخصي أو حفظ البيانات أولاً');
                return null;
            }

            return { gistId, personalKey };
        }

        async function saveToSpecificGist() {
            if (!confirm("هل أنت متأكد من أنك تريد التحميل إلى السيرفر؟")) {
                return; // إذا ضغط المستخدم على "إلغاء"، نخرج من الوظيفة
            }

            const credentials = getCredentials();
            if (!credentials) return;

            const { gistId, personalKey } = credentials;

            const xmlContent = generateXMLContent();
            const filename = 'my_database.xml';
            const description = 'my_database XML';

            const gistData = {
                description: description,
                files: {
                    [filename]: {
                        content: xmlContent
                    }
                }
            };

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `token ${personalKey}`
                    },
                    body: JSON.stringify(gistData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to update Gist: ${response.status} ${response.statusText}\n${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                const gistUrl = data.html_url;

                showOutput(`تم تحديث البيانات في Gist .\nرابط Gist: ${gistUrl}`);
            } catch (error) {
                console.error('Error saving to specific Gist:', error);
                showOutput(`فشل في حفظ البيانات إلى Gist المحدد. الخطأ: ${error.message}`);
            }
        }

        async function loadFromSpecificGist() {
            const credentials = getCredentials();
            if (!credentials) return;

            const { gistId, personalKey } = credentials;

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${personalKey}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch Gist');
                }

                const data = await response.json();
                const filename = Object.keys(data.files)[0];
                const content = data.files[filename].content;

                // Parse and load the XML content
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(content, "text/xml");
                
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error("XML غير صالح في Gist");
                }
                
                // Clear existing groups and load new data
                document.getElementById('groups').innerHTML = '';
                groupCount = 0;

                // Parse and add groups, sections, and steps
                const groups = xmlDoc.getElementsByTagName('group');
                for (let group of groups) {
                    const groupTitle = group.getElementsByTagName('title')[0].textContent;
                    addGroup(groupTitle);
                    const sections = group.getElementsByTagName('section');
                    for (let section of sections) {
                        const sectionTitle = section.getElementsByTagName('title')[0].textContent;
                        addSection(`group-${groupCount}`, sectionTitle);
                        const steps = section.getElementsByTagName('step');
                        const sectionElement = document.querySelector(`#group-${groupCount} .sections section:last-child`);
                        for (let step of steps) {
                            const description = deserializeStyledContent(step.getElementsByTagName('description')[0].innerHTML);
                            const command = step.getElementsByTagName('command')[0]?.textContent || '';
                            const link = step.getElementsByTagName('link')[0]?.textContent || '';
                            const codeBlock = step.getElementsByTagName('code_block')[0]?.textContent || '';
                            const imageUrl = step.getElementsByTagName('image')[0]?.textContent || '';
                            addStep(sectionElement.querySelector('button'), description, command, link, codeBlock, imageUrl);
                        }
                    }
                }
                
                updateGroupNavigation();
                const firstGroup = document.querySelector('.group-page');
                if (firstGroup) {
                    showGroup(firstGroup.id);
                }

                showOutput("تم تحميل البينات من السيرفر");
            } catch (error) {
                console.error('Error loading from specific Gist:', error);
                showOutput('فشل في تحميل البيانات من Gist المحدد. راجع وحدة التحكم للحصول على التفصيل.');
            }
        }


        function deserializeStyledContent(content) {
            return content.replace(/<styled(.*?)>(.*?)<\/styled>/g, (match, styles, text) => {
                const span = document.createElement('span');
                span.textContent = text;
                if (styles.includes('bold="true"')) {
                    span.style.fontWeight = 'bold';
                }
                const colorMatch = styles.match(/color="(.*?)"/);
                if (colorMatch) {
                    span.style.color = colorMatch[1];
                }
                return span.outerHTML;
            });
        }
        function showOutput(message) {
            const outputArea = document.getElementById('outputArea');
            const outputMessage = document.getElementById('outputMessage');
            outputMessage.textContent = message;
            outputArea.classList.remove('hidden');
            
            // إضافة هذا السطر لإخفاء الرسالة بعد 4 ثواني
            setTimeout(hideOutput, 4000);
        }

        // إضافة هذه الدالة الجديدة
        function hideOutput() {
            const outputArea = document.getElementById('outputArea');
            outputArea.classList.add('hidden');
        }

        function generateXMLContent() {
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n<my_database>\n';
            
            document.querySelectorAll('#groups > div').forEach(group => {
                const groupTitle = group.querySelector('input').value;
                xmlContent += `  <group>\n    <title>${escapeXML(groupTitle)}</title>\n`;
                
                group.querySelectorAll('.sections > section').forEach(section => {
                    const sectionTitle = section.querySelector('input').value;
                    xmlContent += `    <section>\n      <title>${escapeXML(sectionTitle)}</title>\n`;
                    
                    section.querySelectorAll('ol > li').forEach(step => {
                        const stepDescription = step.querySelector('textarea').value;
                        const commandBox = step.querySelector('.command-box');
                        const linkBox = step.querySelector('.link-box');
                        const codeBlock = step.querySelector('.code-block');
                        const imageBox = step.querySelector('.image-box');
                        
                        xmlContent += `      <step>\n        <description>${escapeXML(stepDescription)}</description>\n`;
                        
                        if (linkBox) {
                            const link = linkBox.querySelector('a').href;
                            xmlContent += `        <link>${escapeXML(link)}</link>\n`;
                        }
                        
                        if (codeBlock) {
                            const code = codeBlock.querySelector('textarea').value;
                            xmlContent += `        <code_block>${escapeXML(code)}</code_block>\n`;
                        }
                        
                        if (commandBox) {
                            const command = commandBox.querySelector('textarea').value;
                            if (command) {
                                xmlContent += `        <command>${escapeXML(command)}</command>\n`;
                            }
                        }
                        
                        if (imageBox) {
                            const imageUrl = imageBox.querySelector('img').src;
                            xmlContent += `        <image>${escapeXML(imageUrl)}</image>\n`;
                        }
                        
                        xmlContent += `      </step>\n`;
                    });
                    
                    xmlContent += `    </section>\n`;
                });
                
                xmlContent += `  </group>\n`;
            });
            
            xmlContent += '</my_database>';
            return xmlContent;
        }

        function saveToXMLFile() {
            const xmlContent = generateXMLContent();
            const blob = new Blob([xmlContent], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // إنشاء اسم الملف مع التاريخ والوقت
            const now = new Date();
            const fileName = `my_database_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}.xml`;
            
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showOutput(`تم استخراج البيانات إلى ملف XML باسم ${fileName}`);
        }

        function browseFile(button) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*'; // قبول الصور فقط
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imageUrl = event.target.result;
                        addImage(button, imageUrl, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function loadFromXMLFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xml';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const xmlContent = e.target.result;
                        parseAndLoadXML(xmlContent);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function parseAndLoadXML(xmlContent) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
            
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                showOutput("XML غير صالح في الملف المحدد");
                return;
            }
            
            // Clear existing groups
            document.getElementById('groups').innerHTML = '';
            groupCount = 0;

            // Parse and add groups, sections, and steps
            const groups = xmlDoc.getElementsByTagName('group');
            for (let group of groups) {
                const groupTitle = group.getElementsByTagName('title')[0].textContent;
                addGroup(groupTitle);
                const sections = group.getElementsByTagName('section');
                for (let section of sections) {
                    const sectionTitle = section.getElementsByTagName('title')[0].textContent;
                    addSection(`group-${groupCount}`, sectionTitle);
                    const steps = section.getElementsByTagName('step');
                    const sectionElement = document.querySelector(`#group-${groupCount} .sections section:last-child`);
                    for (let step of steps) {
                        const description = deserializeStyledContent(step.getElementsByTagName('description')[0].innerHTML);
                        const command = step.getElementsByTagName('command')[0]?.textContent || '';
                        const link = step.getElementsByTagName('link')[0]?.textContent || '';
                        const codeBlock = step.getElementsByTagName('code_block')[0]?.textContent || '';
                        const imageUrl = step.getElementsByTagName('image')[0]?.textContent || '';
                        addStep(sectionElement.querySelector('button'), description, command, link, codeBlock, imageUrl);
                    }
                }
            }
            
            updateGroupNavigation();
            const firstGroup = document.querySelector('.group-page');
            if (firstGroup) {
                showGroup(firstGroup.id);
            }
            
            showOutput("تم تحميل البيانات من ملف XML");
        }

        function saveToXMLFile() {
            const xmlContent = generateXML();
            const blob = new Blob([xmlContent], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // إنشاء اسم الملف مع التاريخ والوقت
            const now = new Date();
            const fileName = `my_database_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}.xml`;
            
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showOutput(`تم استخراج البيانات إلى ملف XML باسم ${fileName}`);
        }

        function addImage(button, imageUrl, fileName = '') {
            const step = button.closest('li');
            const imageHtml = `
                <div class="image-box bg-gray-100 p-2 rounded-lg mb-2">
                    <img src="${imageUrl}" alt="صورة توضيحية" class="w-full h-auto cursor-pointer" onclick="showImagePopup('${imageUrl}')">
                    <p class="mt-2">${fileName} <button onclick="copyFilePath('${imageUrl}')" class="bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition duration-300 ease-in-out">نسخ المسار</button></p>
                    <button onclick="removeImage(this)" class="text-red-500 hover:text-red-700 mt-2">إزالة الصورة</button>
                </div>
            `;
            step.insertAdjacentHTML('beforeend', imageHtml);
            updateXML();
        }

        function copyFilePath(path) {
            navigator.clipboard.writeText(path).then(() => {
                alert('تم نسخ مسار الصورة إلى الحافظة!');
            }).catch(err => {
                console.error('فشل في نسخ المسار: ', err);
                alert('فشل في نسخ المسار. يرجى المحاولة مرة أخرى.');
            });
        }
        function serializeStyledContent(content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            return Array.from(tempDiv.childNodes).map(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    let styles = '';
                    if (node.style.fontWeight === 'bold') {
                        styles += ' bold="true"';
                    }
                    if (node.style.color) {
                        styles += ` color="${node.style.color}"`;
                    }
                    return `<styled${styles}>${node.textContent}</styled>`;
                }
            }).join('');
        }

        function generateXML() {
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n<my_database>\n';
            
            document.querySelectorAll('#groups > div').forEach(group => {
                const groupTitle = group.querySelector('input').value;
                xmlContent += `  <group>\n    <title>${escapeXML(groupTitle)}</title>\n`;
                
                group.querySelectorAll('.sections > section').forEach(section => {
                    const sectionTitle = section.querySelector('input').value;
                    xmlContent += `    <section>\n      <title>${escapeXML(sectionTitle)}</title>\n`;
                    
                    section.querySelectorAll('ol > li').forEach(step => {
                        const stepDescription = step.querySelector('textarea').value;
                        const commandBox = step.querySelector('.command-box');
                        const linkBox = step.querySelector('.link-box');
                        const codeBlock = step.querySelector('.code-block');
                        const imageBox = step.querySelector('.image-box');
                        
                        xmlContent += `      <step>\n        <description>${escapeXML(serializeStyledContent(stepDescription))}</description>\n`;
                        
                        if (linkBox) {
                            const link = linkBox.querySelector('a').href;
                            xmlContent += `        <link>${escapeXML(link)}</link>\n`;
                        }
                        
                        if (codeBlock) {
                            const code = codeBlock.querySelector('textarea').value;
                            xmlContent += `        <code_block>${escapeXML(code)}</code_block>\n`;
                        }
                        
                        if (commandBox) {
                            const command = commandBox.querySelector('textarea').value;
                            if (command) {
                                xmlContent += `        <command>${escapeXML(command)}</command>\n`;
                            }
                        }
                        
                        if (imageBox) {
                            const imageUrl = imageBox.querySelector('img').src;
                            xmlContent += `        <image>${escapeXML(imageUrl)}</image>\n`;
                        }
                        
                        xmlContent += `      </step>\n`;
                    });
                    
                    xmlContent += `    </section>\n`;
                });
                
                xmlContent += `  </group>\n`;
            });
            
            xmlContent += '</my_database>';
            
            return xmlContent;
        }
    </script>
</body>
</html>
